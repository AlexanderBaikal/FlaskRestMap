(()=>{"use strict";const t=function(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r={"Content-Type":"application/json; charset=utf-8"};o&&(console.log("token exists"),r.Authorization="Bearer "+o);var a={method:t,headers:r};return e&&(a.body=JSON.stringify(e)),fetch(n,a).then((function(t){return t.ok?t.json():t.json().then((function(t){throw Error(JSON.stringify(t))}))}))};function n(t){return'<div class="card-body">\n      <h5 class="card-title"><b>'.concat(t.titleContent||"No title yet",'</b></h5>\n      <p class="card-text">\n       <h6>').concat(t.textContent||"No info yet",' </h6><hr/> \n       <p class="text-secondary">\n       <b>Автор: </b>').concat(t.author||"author unknown","\n        <br/>\n        <b>Координаты: </b\n        >").concat(Math.round(100*t.latlang.lat)/100+" "+Math.round(100*t.latlang.lng)/100,"<br/><b>Дата создания: </b>").concat(t.created||"2021",'\n        </p>\n      </p>\n      <div class="btn-toolbar">\n        <button type="button" class="btn btn-primary edit-btn">Редактировать</button>\n        <button type="button" class="btn btn-danger delete-btn ms-2">Удалить</button>\n      </div>\n    </div>')}function e(t,e){var a=e.marker;a._popup.setContent(n(a)),t.target.openPopup();var c=localStorage.getItem("current"),l=document.querySelector(".edit-btn");a.author!=c?l.style.display="none":l.style.display="block",l.addEventListener("click",(function(){return r(e)}));var u=document.querySelector(".delete-btn");a.author!=c?u.style.display="none":u.style.display="block",u.addEventListener("click",(function(){return o(e)}))}function o(n){var e=n.map,o=n.marker,r=o.id,a=localStorage.getItem("token");t("DELETE","/api/post/".concat(r),null,a).then((function(t){e.removeLayer(o)})).catch((function(t){return alert(t)}))}function r(a){var c=a.marker;c.draggable=!0,c._popup.setContent(function(t){return'\n    <form>\n      <div class="form-group pb-1">\n        <input\n          type="text"\n          class="form-control"\n          id="popup-header"\n          value="'.concat(t.titleContent||"",'"\n          placeholder="Header"\n        />\n      </div>\n      <div class="form-group">\n        <textarea\n          class="form-control form-control-inline"\n          id="popup-textarea"\n          placeholder="Description"\n          rows="3"\n        >').concat(t.textContent||"",'</textarea>\n      </div>\n      <button type="button" class="btn btn-secondary btn-sm move-btn">\n        Переместить\n      </button>\n      <button type="button" class="btn btn-primary btn-sm apply-btn">\n        Применить\n      </button>\n    </form>\n  ')}(c)),document.querySelector(".apply-btn").addEventListener("click",(function(){return function(e){var a=e.marker,c={title:document.getElementById("popup-header").value,text:document.getElementById("popup-textarea").value,coords:a.latlang,created:a.created,id:a.id},l=localStorage.getItem("token"),u=a.id;t("PUT","/api/post/".concat(u),c,l).then((function(t){!function(){a.titleContent=document.getElementById("popup-header").value,a.textContent=document.getElementById("popup-textarea").value,a._popup.setContent(n(a));var t=document.querySelector(".edit-btn");t&&t.addEventListener("click",(function(){return r(e)}));var c=document.querySelector(".delete-btn");c&&c.addEventListener("click",(function(){return o(e)}))}()})).catch((function(t){return alert(t)}))}(a)})),document.querySelector(".move-btn").addEventListener("click",(function(){return function(n){var o=n.marker,r=n.map,a=localStorage.getItem("current");o.author==a&&(o.off("mouseover"),o.off("click"),r.closePopup(),o.dragging.enable(),o.on("dragend",(function(){return function(n){var o=n.marker,r=n.map;o.latlang=o.getLatLng(),o.on("mouseover",(function(t){return e(t,{marker:o,map:r})})),o.off("dragend");var a=localStorage.getItem("current");if(o.author==a){var c=o.id,l=localStorage.getItem("token"),u={title:o.titleContent,text:o.textContent,coords:o.latlang,created:o.created,id:o.id};t("PUT","/api/post/".concat(c),u,l).then((function(t){})).catch((function(t){return alert(t)}))}else alert("Pos not changed")}(n)})))}(a)}))}function a(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,o=new Array(n);e<n;e++)o[e]=t[e];return o}!function(){var n=L.tileLayer("http://vec{s}.maps.yandex.net/tiles?l=map&v=4.55.2&z={z}&x={x}&y={y}&scale=2&lang=ru_RU",{subdomains:["01","02","03","04"],attribution:'<a http="yandex.ru" target="_blank">Яндекс</a>',reuseTiles:!0,updateWhenIdle:!1}),o=L.icon({iconUrl:"static/img/msg.png",iconSize:[30,30]}),r=L.map("map").addLayer(n).setView([52.09,104.28],13),c=[];function l(t){var n=new L.marker(t.coords,{icon:o});n.id=t.id,n.titleContent=t.title,n.textContent=t.text,n.author=t.author.username,n.created=t.created?t.created:(new Date).toLocaleString(),n.latlang=t.coords,n.on("mouseover",(function(t){return e(t,{marker:n,map:r})})),n.bindPopup(),n.addTo(r)}function u(){document.getElementById("inputNavGroup").innerHTML='\n   <div class="input-group-prepend ">\n      <span class="input-group-text" id="basic-addon1">@</span>\n    </div>\n    <input\n      type="text"\n      class="form-control"\n      id="inputEmail"\n      placeholder="Username"\n      aria-label="Username"\n      aria-describedby="basic-addon1"\n      autocomplete="on"\n    />\n    <div class="input-group-prepend ps-2">\n      <span class="input-group-text" id="basic-addon2">*</span>\n    </div>\n    <input\n      type="password"\n      class="form-control"\n      id="inputPassword"\n      placeholder="Password"\n      aria-label="Password"\n      aria-describedby="basic-addon1"\n      autocomplete="on"\n    />\n    <button\n      type="button"\n      id="loginBtn"\n      class="btn btn-secondary btn-sm ms-2 rounded"\n    >\n      Вход\n    </button>\n    <button\n      type="button"\n      id="registerBtn"\n      class="btn btn-secondary btn-sm ms-2 rounded"\n    >\n      Регистрация\n    </button>',document.getElementById("registerBtn").addEventListener("click",(function(){return d("register")})),document.getElementById("loginBtn").addEventListener("click",(function(){return d("login")}))}function i(t){localStorage.setItem("current",null),localStorage.setItem("token",null),u(),r.closePopup()}function d(n){if(function(t){var n=!1,e=t.getElementById("inputEmail"),o=t.getElementById("inputPassword");if(""==e.value||null==e.value){e.style.border="1px solid red",n=!0;var r=t.getElementById("basic-addon1");r.style.color="red",r.innerHTML="!"}if(""==o.value||null==o.value){o.style.border="1px solid red",n=!0;var a=t.getElementById("basic-addon2");a.style.color="red",a.innerHTML="!"}return!n}(document)){var e=document.getElementById("inputEmail").value||"username",o=document.getElementById("inputPassword").value||"password",a={username:e,password:o};t("POST","api/".concat(n),a).then((function(n){localStorage.setItem("token",n.token),localStorage.setItem("current",e),document.getElementById("inputNavGroup").innerHTML=function(t){return' <div class="input-group-prepend ps-3">\n        <span class="label label-default d-inline-flex p-1">'.concat(t,'</span>\n      </div>\n      <button\n        type="button"\n        class="btn btn-primary btn-sm ms-2 add-marker rounded"\n      >\n        Добавить маркер\n      </button>\n      <button\n        type="button"\n        class="btn btn-secondary btn-sm ms-2 add-marker rounded"\n        id="logoutButton"\n      >\n        Выход\n      </button>')}(e),document.getElementById("logoutButton").addEventListener("click",i),document.querySelector(".add-marker").addEventListener("click",(function(){return function(){var n=localStorage.getItem("token"),e={title:"",text:"",coords:r.getCenter()};t("POST","/api/posts",e,n).then((function(t){l(t)})).catch((function(t){return alert(t)}))}()}))})).catch((function(t){alert(t)}))}}t("GET","/api/posts/").then((function(t){!function(t){var n,e=function(t,n){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=function(t,n){if(t){if("string"==typeof t)return a(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?a(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){e&&(t=e);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,l=!0,u=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return l=t.done,t},e:function(t){u=!0,c=t},f:function(){try{l||null==e.return||e.return()}finally{if(u)throw c}}}}(t);try{for(e.s();!(n=e.n()).done;){var o=n.value;-1===c.indexOf(o.id)&&(c.push(o.id),l(o))}}catch(t){e.e(t)}finally{e.f()}}(t)})).catch((function(t){return alert(t)})),u(),localStorage.setItem("token",null),localStorage.setItem("current",null)}()})();